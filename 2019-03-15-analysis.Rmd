---
title: "analysis"
author: "Joshua Rosenberg"
date: "9/13/2018"
html_document:
    toc: true
    toc_depth: 2
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, messages = FALSE, warning = FALSE)
```

# Update on qualitative coding

## Item #13 - Please explain the one or two technology competencies that you consider as being most important to your individual work as a teacher educator.

## Loading, setting up

In this section, we start out by doing:

```{r, load-packages, message = FALSE}
library(tidyverse)
library(ggridges)
library(corrr)
library(clipr)
usethis::use_git_ignore("*.csv")
```

Read the data:

```{r, load-data, eval = TRUE}
# d <- read_csv("tetcs-survey-export.csv", skip = 0)
d <- read_csv("full-tetcs-dataset.csv")
d <- d %>% slice(-c(1:2))
```

Check that the data loaded:

```{r, check-that-data-loaded}
d
```

Process the TETCs variables:

```{r}
ds <- d %>% 
    select(Q11_1:Q11_12) %>% 
    set_names(1:12) %>% 
    mutate_all(str_extract, "\\(?[0-9,.]+\\)?") %>% 
    mutate_all(as.integer) %>% 
    set_names(str_c("v", 1:12))

ds %>% 
    summarize_all(funs(mean, sd), na.rm = TRUE) %>%
    gather(key, val) %>% 
    separate(key, into = c("var", "stat")) %>% 
    spread(stat, val) %>% 
    mutate(TETC = str_sub(var, start = 2),
           TETC = as.integer(TETC)) %>% 
    arrange(TETC) %>% 
    mutate(TETC = str_c("TETC", TETC)) %>% 
    mutate(mean = round(mean, 2),
           sd = round(sd, 2)) %>% 
    mutate(mean_sd = str_c(mean, " (", sd, ")")) %>% 
    select(mean_sd) %>% 
    clipr::write_clip()

c <- cbind(ds)

g <- ds %>% 
    gather(key, val)

summary(aov(val ~ key, g))
```

```{r}
rec_f <- function(x) {
    recode(x, 
           `Major asset I experience / have experienced.` = 5,
           `Asset I experience / have experienced.` = 4,
           `Neutral / neither a barrier nor an asset.` = 3,
           `Barrier I experience / have experienced.` = 2,
           `Major barrier I experience / have experienced.` = 1
           )
}
    
dd <- d %>% 
    select(Q18_1:Q18_9) %>% 
    mutate_all(rec_f)


ddd <- dd %>% 
    gather(key, val) %>% 
    mutate(key = str_replace(key, "v", "Asset/Barier")) %>% 
    group_by(key) %>% 
    summarize(mean_val = mean(val, na.rm = TRUE),
              sd_val = sd(val, na.rm = TRUE)) %>% 
    arrange(desc(mean_val))

dd %>% 
    gather(key, val) %>% 
    ggplot() +
    geom_jitter(aes(x = key, y = val), 
                alpha = .5, 
                color = "gray", 
                height = 0.2) +
    geom_point(data = ddd,
               aes(x = key, y = mean_val),
               size = 2.5) +
    geom_errorbar(data = ddd,
                  aes(x = key, y = mean_val,
                      ymin = mean_val-sd_val,
                      ymax = mean_val+sd_val)) +
    theme_bw() +
    ylab("Value") +
    xlab(NULL) +
    theme(text = element_text(size = 14),
          axis.text.x = element_text(angle = 45, hjust = 1))

ggsave('assets-barriers-plot.png', width = 8, height = 6)
```
```

Access to educational technologies (1)
Time to try out and use educational technologies  (2)
Technical and instructional design support to use educational technologies (3)
Leadership around my department / program’s use of educational technology (4)
A clear vision or plan related to my department / program’s use of educational technology (5)
The role of technology in the subject matter(s) I focus on (6)
My beliefs about the role of educational technologies in teaching and learning (7)
Confidence in my ability to use educational technology (8)
Confidence in my ability to integrate educational technologies with my own pedagogical strategies (9)

# Demographics

## Years of experience

```{r}
d <-d %>%
    mutate(Q5_1=as.integer(Q5_1),
           Q5_2=as.integer(Q5_2)) %>% 
    bind_cols(ds)

ps <- d %>% 
    select(years_teach_exp = Q5_1, 
           yeras_te_exp = Q5_2,
           v1:v12) %>% 
    as.matrix() %>% 
    Hmisc::rcorr() %>% 
    pluck(3) %>% 
    as.data.frame() %>% 
    select(1:2) %>% 
    slice(3:nrow(.)) %>% 
    unlist() %>% 
    p.adjust(method = "hochberg") %>% 
    matrix(ncol = 2) %>% 
    as_tibble() %>%
    set_names(c("years_tch_exp", "years_te_experience"))
    mutate_all(~ ifelse(. < .05, "*", ""))

rs <- d %>% 
    select(years_teach_exp = Q5_1, 
           yeras_te_exp = Q5_2,
           v1:v12) %>% 
    as.matrix() %>% 
    Hmisc::rcorr() %>% 
    pluck(1) %>% 
    as.data.frame() %>% 
    select(1:2) %>% 
    slice(3:14) %>% 
    set_names(c("years_tch_exp", "years_te_experience"))

data.frame(v1 = str_c(round(rs$years_tch_exp,2), ps$years_tch_exp),
           v2 = str_c(round(rs$years_te_experience,2), ps$years_te_experience)) %>% 
    clipr::write_clip()

cs <- d %>% 
    select(years_teach_exp = Q5_1, 
           yeras_te_exp = Q5_2,
           v1:v12) %>% 
    corrr::correlate() %>% 
    corrr::shave() %>% 
    corrr::fashion()

dcc <- d %>% 
    select(years_teach_exp = Q5_1, 
           yeras_te_exp = Q5_2,
           v1:v12)

```

```{r, eval=F}
library(CCA)
library(CCP)

cco <- CCA::cc(as.matrix(dcc[, 1:12]), dcc[, 13:14])
rho <- cco$cor
cco$cor

cc <- comput(as.matrix(dcc[, 1:12]), dcc[, 13:14], cco)
cc[3:6]

dcc

x <- lm(cbind(as.matrix(dcc[, 1:12])) ~ as.matrix(dcc[, 13]))
x1 <- manova(cbind(as.matrix(dcc[, 1:12])) ~ as.matrix(dcc[, 13]))
str(x)
summary(x)

## Define number of observations, number of variables in first set, and number of variables in the second set.
n <- dim(dcc[, 1:12])[1]
p <- length(dcc[, 1:12])
q <- length(dcc[, 13:14])

## Calculate p-values using the F-approximations of different test statistics:
p.asym(rho, n, p, q, tstat = "Wilks")
```

```{r}
dss <- ds %>% 
    gather(key, val) %>% 
    mutate(key = str_replace(key, "v", "TETC-"))

dss$key = with(dss, reorder(key, val, mean, na.rm = TRUE))

dss %>% 
    ggplot(aes(x = reorder(key, val), y = val)) +
    geom_violin() +
    # geom_jitter() +
    theme_bw() +
    ylab("Value") +
    xlab(NULL) +
    ylim(1, 5)
```

```{r}
dss <- ds %>% 
    gather(key, val) %>% 
    mutate(key = str_replace(key, "v", "TETC-"))

dss$key = with(dss, reorder(key, val, mean, na.rm = TRUE))

dss %>% 
    ggplot(aes(y = key, x = val)) +
    geom_density_ridges(scale = .9) +
    theme_bw() +
    ylab("Value") +
    xlab(NULL) +
    xlim(1, 5)
```

```{r}
summary(aov(val~key, data = dss))
```

```{r}
# fit1 = hotelling.test(. ~ is_sync, data = ds)
# fit1

#str_c(round(mean(dd$val, na.rm = TRUE), 3), " (", round(sd(dd$val, na.rm = TRUE), 3), ")")

dd <- ds %>% 
    gather(key, val) %>% 
    mutate(key = str_replace(key, "v", "TETC-")) %>% 
    mutate(key = factor(key, levels = c("TETC-4", "TETC-12", "TETC-3", "TETC-2", "TETC-7", "TETC-6", "TETC-1", "TETC-10", "TETC-5", "TETC-9", "TETC-11", "TETC-8")))

d <- ds %>% 
    gather(key, val) %>% 
    mutate(key = str_replace(key, "v", "TETC-")) %>% 
    group_by(key) %>% 
    summarize(mean_val = mean(val, na.rm = TRUE),
              sd_val = sd(val, na.rm = TRUE)) %>% 
    arrange(desc(mean_val))

d %>% 
    ggplot() +
    geom_jitter(data = dd, aes(x = reorder(key, val), y = val), alpha = .5, color = "gray", height = 0.2) +
    geom_point(aes(x = reorder(key, mean_val), y = mean_val), size = 2.5) +
    geom_errorbar(aes(x = reorder(key, mean_val),
                      ymin = mean_val-sd_val,
                      ymax = mean_val+sd_val)) +
    theme_bw() +
    ylab("Value") +
    xlab(NULL) +
    theme(text = element_text(size = 14),
          axis.text.x = element_text(angle = 45, hjust = 1))

ggsave('tetc-plot.png', width = 8, height = 6)
```

## Grade level

```{r}
d  %>% 
    count(Q7) %>% 
    arrange(desc(n))%>% 
    write_csv("grade-levels.csv")

m <- read_csv("grade-levels-m.csv")
m <- m %>% set_names(c("Q7", "Q7n", "Q7_code"))

d <- d %>% left_join(m, by = "Q7")

dd <- d %>% select(v1:v12, Q7_code)
c <- cbind(dd[, 1:12])
m <- manova(as.matrix(c) ~ dd$Q7_code)
summary(m)

d %>% 
    select(v1:v12) %>% 
    map(~ aov(. ~ d$Q7_code)) %>% 
    map_df(tidy) %>% 
    filter(term != "Residuals") %>% 
    mutate(var = str_c("v", 1:12)) %>% 
    select(var, sumsq, statistic, p.value) %>% 
    mutate(p.value_adj = p.adjust(p.value, method = "hochberg"))

d %>% 
    select(v1:v12) %>% 
    map(~ aov(. ~ d$Q7_code)) %>% 
    map(TukeyHSD) %>% 
    map_df(tidy) %>% 
    mutate(var = rep(1:12, each = 6)) %>% 
    mutate_if(is.numeric, round, 3) %>% 
    mutate(est_p = ifelse(adj.p.value < .001, str_c(estimate, "***"),
                          ifelse(adj.p.value < .01, str_c(estimate, "**"),
                                 ifelse(adj.p.value < .05, str_c(estimate, "*"), estimate)))) %>%     select(var, comparison, est_p) %>% 
    spread(comparison, est_p) %>%
    write_csv("grade-tukey.csv")

dm <- d %>% 
    select(Q7_code, v1:v12) %>% 
    gather(key, val, -Q7_code)

x <- aov(val ~ Q7_code, data = dm)

TukeyHSD(x) %>% 
    pluck(1) %>% 
    as.data.frame() %>% 
    rownames_to_column("comparison") %>% 
    mutate_if(is.numeric, round, 3)
    clipr::write_clip()

summary(aov(val ~ Q7_code*key, data = dm))

sg <- d %>% 
    select(Q7_code, v1:v12) %>% 
    gather(key, val, -Q7_code) %>% 
    group_by(Q7_code) %>% 
    summarize(mean = mean(val, na.rm = TRUE),
              sd = sd(val, na.rm = TRUE)) %>% 
    ggplot(aes(x = reorder(Q7_code, mean), y = mean, ymin = mean - ((1.96*sd)/sqrt(336)), ymax = mean +((1.96*sd)/sqrt(336)))) +
    geom_col() +
    geom_errorbar() +
    theme_bw() +
    xlab("Grade Level") +
    ylab("Mean TETC value") +
    theme(text = element_text(size = 14)) +
    scale_x_discrete(labels = c("Elementary (n = 58)", 
                                "Secondary (n = 76)",
                                "Other (n = 47)",
                                "All (n = 156)")) +
    xlab(NULL) + coord_flip()

sg

ggsave("grade-plot-1.png", width = 6, height = 5)
```

## Content area/subject

```{r}
d %>%
    count(Q8) %>% 
    arrange(desc(n)) %>% 
    write_csv("subject.csv")

m <- read_csv("subject-m.csv")
m <- m %>% set_names(c("Q8", "Q8n", "Q8_code")) %>% mutate(Q8_code = ifelse(Q8_code == "STEM", "Science and Math", Q8_code))

d <- d %>% left_join(m, by = "Q8")

dd <- d %>% select(v1:v12, Q8_code)
c <- cbind(dd[, 1:12])
m <- manova(as.matrix(c) ~ dd$Q8_code)
summary(m)

d %>% 
    select(v1:v12) %>% 
    map(~ aov(. ~ d$Q8_code)) %>% 
    map_df(tidy) %>% 
    filter(term != "Residuals") %>% 
    mutate(var = str_c("v", 1:12)) %>% 
    select(var, sumsq, statistic, p.value) %>% 
    mutate(p.value_adj = p.adjust(p.value, method = "hochberg")) %>% 
    mutate_if(is.numeric, round, 3)

d %>% 
    select(v1:v12) %>% 
    map(~ aov(. ~ d$Q8_code)) %>% 
    map(TukeyHSD) %>% 
    map_df(tidy) %>% 
    mutate(var = rep(1:12, each = 6)) %>% 
    mutate_if(is.numeric, round, 3) %>% 
    mutate(est_p = ifelse(adj.p.value < .001, str_c(estimate, "***"),
                          ifelse(adj.p.value < .01, str_c(estimate, "**"),
                                 ifelse(adj.p.value < .05, str_c(estimate, "*"), estimate)))) %>% 
    select(var, comparison, est_p) %>% 
    spread(comparison, est_p) %>%
    write_csv("subject-tukey.csv")

dm <- d %>% 
    select(Q8_code, v1:v12) %>% 
    gather(key, val, -Q8_code)

x <- aov(val ~ Q8_code, data = dm)
summary(aov(val ~ Q8_code, data = dm))

TukeyHSD(x) %>% 
    pluck(1) %>% 
    as.data.frame() %>% 
    rownames_to_column("comparison")

TukeyHSD(x)

dm %>% group_by(Q8_code) %>% summarize(mean_val = mean(val, na.rm = T), sd_val = sd(val, na.rm = TRUE))

sp <- d %>% 
    select(Q8_code, v1:v12) %>% 
    filter(!is.na(Q8_code)) %>% 
    gather(key, val, -Q8_code) %>% 
    group_by(Q8_code) %>% 
    summarize(mean = mean(val, na.rm = TRUE),
              sd = sd(val, na.rm = TRUE)) %>% 
    ggplot(aes(x = reorder(Q8_code, mean), y = mean)) +
    geom_col() +
    geom_errorbar(aes(ymin = mean - ((1.96*sd)/sqrt(336)), ymax = mean +((1.96*sd)/sqrt(336)))) +
    theme_bw() +
    xlab("Subject") +
    ylab("Mean TETC value") +
    theme(text = element_text(size = 14)) +
    scale_x_discrete(labels = c("Non Science & Math (n = 97)", 
                                "Science & Math (n = 73)",
                                "Other (n = 78)",
                                "Technology (n = 42)")) +
    xlab(NULL) + coord_flip()

sp

ggsave("subject-plot.png", width = 7, height = 5)
```

```{r}
cowplot::plot_grid(sg, sp)
ggsave("sg-sp.png", width = 10, height = 6) 
```

# Joining data - this is to join the qualitative data (not run right now)

```{r, eval = FALSE}
library(googlesheets)
g <- gs_title("Teacher Education Technology Competencies Survey_November 12, 2018_20.32")
```

```{r}
d2 <- gs_read(g, ws = 2, skip = 1)
d2 <- d2 %>% rename(Q13 = `Please explain the one or two technology competencies that you consider as being most important to your individual work as a teacher educator.`) %>% slice(-c(338:339))
d2 <- d2 %>% set_names(c("Q13", str_c("Q13-", names(d2)[-1])))
d2 <- d2 %>% filter(!duplicated(Q13))

d3 <- gs_read(g, ws = 3, skip = 1)
d3 <- d3 %>% rename(Q14 = `Please explain one or more of the technology competencies that you consider of low or no importance to your individual work as a teacher educator.`) %>% slice(-c(338:339))
d3 <- d3 %>% set_names(c("Q14", str_c("Q14-", names(d3)[-1])))
d3 <- d3 %>% filter(!duplicated(Q14))

d4 <- gs_read(g, ws = 4, skip = 1)
d4 <- d4 %>% rename(Q15 = `What is important in your work related to educational technology that is not reflected in the TETCs?`) %>% slice(-c(338:339))
d4 <- d4 %>% set_names(c("Q15", str_c("Q15-", names(d4)[-1])))
d4 <- d4 %>% filter(!duplicated(Q15))
```

```{r}
dx <- d %>% 
    left_join(d2) %>% 
    left_join(d3) %>% 
    left_join(d4)

c13 <- dx %>% 
    select(v1:v12, `Q13-1`:`Q13-12`) %>% 
    mutate_all(replace_na, 0) %>% 
    corrr::correlate() %>% 
    slice() %>% 
    fashion() %>% 
    select(v1:v12) %>% 
    slice(13:24)

c14 <- dx %>% 
    select(v1:v12, `Q14-1`:`Q14-12`) %>% 
    mutate_if(is.character, as.numeric) %>% 
    mutate_all(replace_na, 0) %>% 
    as.matrix() %>% 
    Hmisc::rcorr() %>% 
    as.matrix() %>% 
    # corrr::correlate() %>% 
    slice() %>% 
    fashion() %>% 
    select(v1:v12) %>% 
    slice(13:24)

dd <- data.frame(var = str_c("TETC", 1:12),
                 most_imp_r = as.numeric(diag(as.matrix(c13))),
                 least_imp_r = as.numeric(diag(as.matrix(c14))))

write_csv(dd, "most-least-imp-corr.csv")
```
