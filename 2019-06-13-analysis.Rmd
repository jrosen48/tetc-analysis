---
title: "analysis"
author: "Joshua Rosenberg"
date: "9/13/2018"
html_document:
    toc: true
    toc_depth: 2
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, messages = FALSE, warning = FALSE)
```

# Update on qualitative coding

## Item #13 - Please explain the one or two technology competencies that you consider as being most important to your individual work as a teacher educator.

## Loading, setting up

In this section, we start out by doing:

```{r, load-packages, message = FALSE}
library(tidyverse)
library(ggridges)
library(corrr)
library(clipr)
library(psych)
library(lavaan)
library(broom)

usethis::use_git_ignore("*.csv")
```

Read the data:

```{r, load-data, eval = TRUE}
# d <- read_csv("tetcs-survey-export.csv", skip = 0)
d <- read_csv("full-tetcs-dataset.csv")
d <- d %>% slice(-c(1:2))
```

Check that the data loaded:

```{r, check-that-data-loaded}
d
```

Process the TETCs variables:

```{r}
ds <- d %>% 
    select(Q11_1:Q11_12) %>% 
    set_names(1:12) %>% 
    mutate_all(str_extract, "\\(?[0-9,.]+\\)?") %>% 
    mutate_all(as.integer) %>% 
    set_names(str_c("v", 1:12))

ds %>% 
    summarize_all(funs(mean, sd), na.rm = TRUE) %>%
    gather(key, val) %>% 
    separate(key, into = c("var", "stat")) %>% 
    spread(stat, val) %>% 
    mutate(TETC = str_sub(var, start = 2),
           TETC = as.integer(TETC)) %>% 
    arrange(TETC) %>% 
    mutate(TETC = str_c("TETC", TETC)) %>% 
    mutate(mean = round(mean, 2),
           sd = round(sd, 2)) %>% 
    mutate(mean_sd = str_c(mean, " (", sd, ")")) %>% 
    select(mean_sd)

# c <- cbind(ds)
# 
# g <- ds %>% 
#     gather(key, val)
# 
# summary(aov(val ~ key, g))
```

```{r}
rec_f <- function(x) {
    recode(x, 
           `Major asset I experience / have experienced.` = 5,
           `Asset I experience / have experienced.` = 4,
           `Neutral / neither a barrier nor an asset.` = 3,
           `Barrier I experience / have experienced.` = 2,
           `Major barrier I experience / have experienced.` = 1
           )
}
    
dd <- d %>% 
    select(Q18_1:Q18_9) %>% 
    mutate_all(rec_f)

ddd <- dd %>% 
    gather(key, val) %>% 
    mutate(key = str_replace(key, "v", "Asset/Barier")) %>% 
    group_by(key) %>% 
    summarize(mean_val = mean(val, na.rm = TRUE),
              sd_val = sd(val, na.rm = TRUE)) %>% 
    arrange(desc(mean_val))

dd %>% 
    gather(key, val) %>% 
    ggplot() +
    geom_jitter(aes(x = key, y = val), 
                alpha = .5, 
                color = "gray", 
                height = 0.2) +
    geom_point(data = ddd,
               aes(x = key, y = mean_val),
               size = 2.5) +
    geom_errorbar(data = ddd,
                  aes(x = key, y = mean_val,
                      ymin = mean_val-sd_val,
                      ymax = mean_val+sd_val)) +
    theme_bw() +
    ylab("Value") +
    xlab(NULL) +
    theme(text = element_text(size = 14),
          axis.text.x = element_text(angle = 45, hjust = 1)) +
    scale_x_discrete(limits = c("Q18_7", "Q18_9", "Q18_8", "Q18_6", "Q18_1", "Q18_3", "Q18_4", "Q18_5", "Q18_2"))

ggsave('assets-barriers-plot.png', width = 8, height = 6)
```
# EFA
```{r}
scree(dd[complete.cases(dd), ])
f <- fac(dd[complete.cases(dd), ], nfactors = 2)
print(f)
```

# CFA
```{R}
mod <- 'access  =~ Q18_1 + Q18_2 + Q18_3
             vision =~ Q18_4 + Q18_5 + Q18_6
             personal   =~ Q18_7 + Q18_8 +Q18_9'

c2a <- cfa(mod, data = dd)
summary(c2a, fit.measures = TRUE)

modb <- 'access  =~ Q18_1 + Q18_2 + Q18_3
             vision =~ Q18_4 + Q18_5
             personal   =~ Q18_7 + Q18_8 +Q18_9'

c2b <- cfa(modb, data = dd)
summary(c2b, fit.measures = TRUE)
fs <- lavaan::lavPredict(c2b, newdata = dd)

names(fs) <- str_c("fs", 1:3)

mod1 <- 'access_vision  =~ Q18_1 + Q18_2 + Q18_3 + Q18_4 + Q18_5 + Q18_6
             personal   =~ Q18_7 + Q18_8 +Q18_9'

c3 <- cfa(mod1, data = dd)
summary(c3, fit.measures = TRUE)
```

Items: 

- access: Access to educational technologies (1)
- access: Time to try out and use educational technologies  (2)
- access: Technical and instructional design support to use educational technologies (3)
- vision: Leadership around my department / program’s use of educational technology (4)
- vision: A clear vision or plan related to my department / program’s use of educational technology (5) 
- CUT: The role of technology in the subject matter(s) I focus on (6)
- personal: My beliefs about the role of educational technologies in teaching and learning (7)
- personal: Confidence in my ability to use educational technology (8)
- personal: Confidence in my ability to integrate educational technologies with my own pedagogical strategies (9)

```{r}
dx <- ds[complete.cases(dd), ] %>% 
    mutate(id = 1:nrow(.)) %>% 
    gather(key, val, -id) %>% 
    group_by(id) %>% 
    summarize(mean_tetc = mean(val)) %>% 
    cbind(fs) %>% 
    as_tibble()

dx %>% 
    corrr::correlate() %>% 
    slice(3:5) %>% 
    select(-id)

dx %>% 
    as.matrix() %>% 
    Hmisc::rcorr()
```

# Demographics - RQ3

## Grade level

```{r}
m <- read_csv("grade-levels-m.csv")
m <- m %>% set_names(c("Q7", "Q7n", "Q7_code"))

dg <- d %>% 
    left_join(m, by = "Q7") %>% 
    filter(complete.cases(dd)) %>% 
    cbind(dx) %>% 
    as_tibble()

summary(aov(access ~ Q7_code, data = dg))
summary(aov(vision ~ Q7_code, data = dg))
summary(aov(personal ~ Q7_code, data = dg))
TukeyHSD(aov(personal ~ Q7_code, data = dg))
```

```{r}
dg %>% 
    select(Q7_code, access, vision, personal) %>% 
    gather(key, val, -Q7_code) %>% 
    group_by(Q7_code, key) %>% 
    summarize(mean_val = mean(val)) %>% 
    ggplot(aes(x = key, y = mean_val, fill = Q7_code)) +
    geom_col(position = 'dodge')
```

## Content area/subject

```{r}
m <- read_csv("subject-m.csv")
m <- m %>% set_names(c("Q8", "Q8n", "Q8_code")) %>% mutate(Q8_code = ifelse(Q8_code == "STEM", "Science and Math", Q8_code))

dg <- d %>% 
    left_join(m, by = "Q8") %>% 
    filter(complete.cases(dd)) %>% 
    cbind(dx) %>% 
    as_tibble()

summary(aov(access ~ Q8_code, data = dg))
TukeyHSD(aov(access ~ Q8_code, data = dg))
summary(aov(vision ~ Q8_code, data = dg))
summary(aov(personal ~ Q8_code, data = dg))
TukeyHSD(aov(personal ~ Q8_code, data = dg))
```

```{r}
dg %>% 
    select(Q8_code, access, vision, personal) %>% 
    gather(key, val, -Q8_code) %>% 
    group_by(Q8_code, key) %>% 
    summarize(mean_val = mean(val)) %>% 
    ggplot(aes(x = key, y = mean_val, fill = Q8_code)) +
    geom_col(position = 'dodge')
```
