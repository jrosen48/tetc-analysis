---
title: "analysis"
author: "Joshua Rosenberg"
date: "9/13/2018"
html_document:
    toc: true
    toc_depth: 2
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, messages = FALSE, warning = FALSE)
```

# Update on qualitative coding

## Item #13 - Please explain the one or two technology competencies that you consider as being most important to your individual work as a teacher educator.

## Loading, setting up

In this section, we start out by doing:

```{r, load-packages, message = FALSE}
library(tidyverse)
library(ggridges)
library(corrr)
library(clipr)
usethis::use_git_ignore("*.csv")
```

Read the data:

```{r, load-data, eval = TRUE}
# d <- read_csv("tetcs-survey-export.csv", skip = 0)
d <- read_csv("full-tetcs-dataset.csv")
d <- d %>% slice(-c(1:2))
```

Check that the data loaded:

```{r, check-that-data-loaded}
d
```

Process the TETCs variables:

```{r}
ds <- d %>% 
    select(Q11_1:Q11_12) %>% 
    set_names(1:12) %>% 
    mutate_all(str_extract, "\\(?[0-9,.]+\\)?") %>% 
    mutate_all(as.integer) %>% 
    set_names(str_c("v", 1:12))
```

# Demographics

## Years of experience

```{r}
d <-d %>%
    mutate(Q5_1=as.integer(Q5_1),
           Q5_2=as.integer(Q5_2)) %>% 
    bind_cols(ds)

d %>% 
    select(years_teach_exp = Q5_1, 
           yeras_te_exp = Q5_2,
           v1:v12) %>% 
    as.matrix() %>% 
     Hmisc::rcorr() %>% 
    pluck(3) %>% 
    as.data.frame() %>% 
    select(1:2) %>% 
    slice(3:nrow(.)) %>% 
mutate_all(~ ifelse(. < .05, "*", "")) %>% 
    clipr::write_clip()
    
d %>% 
    select(years_teach_exp = Q5_1, 
           yeras_te_exp = Q5_2,
           v1:v12) %>% 
    corrr::correlate() %>% 
    corrr::shave() %>% 
    corrr::fashion() %>% 
    clipr::write_clip()
```

```{r}
dss <- ds %>% 
    gather(key, val) %>% 
    mutate(key = str_replace(key, "v", "TETC-"))

dss$key = with(dss, reorder(key, val, mean, na.rm = TRUE))

dss %>% 
    ggplot(aes(x = reorder(key, val), y = val)) +
    geom_violin() +
    # geom_jitter() +
    theme_bw() +
    ylab("Value") +
    xlab(NULL) +
    ylim(1, 5)
```

```{r}
dss <- ds %>% 
    gather(key, val) %>% 
    mutate(key = str_replace(key, "v", "TETC-"))

dss$key = with(dss, reorder(key, val, mean, na.rm = TRUE))

dss %>% 
    ggplot(aes(y = key, x = val)) +
    geom_density_ridges(scale = .9) +
    theme_bw() +
    ylab("Value") +
    xlab(NULL) +
    xlim(1, 5)
```
```{r}
summary(aov(val~key, data = dss))
```

```{r}
ds %>% 
    gather(key, val) %>% 
    mutate(key = str_replace(key, "v", "TETC-")) %>% 
    group_by(key) %>% 
    summarize(mean_val = mean(val, na.rm = TRUE),
              sd_val = sd(val, na.rm = TRUE)) %>% 
    ggplot(aes(x = reorder(key, mean_val), y = mean_val)) +
    geom_col() +
    geom_errorbar(aes(ymin = mean_val-((2*sd_val)/sqrt(336)),
                      ymax = mean_val+((2*sd_val)/sqrt(336)))) +
    theme_bw() +
    ylab("Value") +
    xlab(NULL) +
    ylim(0, 5)

ggsave('tetc-plot.png', width = 8, height = 6)
```

## Grade level

```{r}
d  %>% 
    count(Q7) %>% 
    arrange(desc(n))%>% 
    write_csv("grade-levels.csv")

m <- read_csv("grade-levels-m.csv")
m <- m %>% set_names(c("Q7", "Q7n", "Q7_code"))

d <- d %>% left_join(m, by = "Q7")
```

```{r}
dm <- d %>% 
    select(Q7_code, v1:v12) %>% 
    gather(key, val, -Q7_code)

x <- aov(val ~ Q7_code*key, data = dm)
x
TukeyHSD(x)
summary(aov(val ~ Q7_code*key, data = dm))

d %>% 
    select(Q7_code, v1:v12) %>% 
    gather(key, val, -Q7_code) %>% 
    group_by(Q7_code, key) %>% 
    summarize(mean = mean(val, na.rm = TRUE),
              sd = sd(val, na.rm = TRUE)) %>% 
    mutate(key = str_sub(key, start = 2),
           key = as.integer(key)) %>% 
    ggplot(aes(x = key, y = mean, fill = Q7_code)) +
    geom_col() +
    geom_errorbar(aes(ymin = mean - ((1.96*sd)/sqrt(336)), ymax = mean +((1.96*sd)/sqrt(336)))) +
    facet_wrap(~Q7_code) +
    scale_fill_discrete("") +
    scale_x_continuous("", breaks = 1:12, labels = 1:12) +
    theme_bw()

ggsave("grade-plot.png", width = 9, height = 6)
```

## Content area

```{r}
d %>%
    count(Q8) %>% 
    arrange(desc(n)) %>% 
    write_csv("subject.csv")

m <- read_csv("subject-m.csv")
m <- m %>% set_names(c("Q8", "Q8n", "Q8_code"))

d <- d %>% left_join(m, by = "Q8")
```

```{r}
dm <- d %>% 
    select(Q8_code, v1:v12) %>% 
    gather(key, val, -Q8_code)

aov(val ~ Q8_code*key, data = dm)
summary(aov(val ~ Q8_code*key, data = dm))
x <- aov(val ~ Q8_code*key, data = dm)
TukeyHSD(x)

dm %>% 
    select(Q8_code, v1:v12) %>% 
    gather(key, val, -Q8_code) %>% 
    group_by(Q8_code, key) %>% 
    summarize(mean = mean(val, na.rm = TRUE),
              sd = sd(val, na.rm = TRUE)) %>% 
    mutate(key = str_sub(key, start = 2),
           key = as.integer(key)) %>% 
    ggplot(aes(x = key, y = mean, fill = Q8_code)) +
    geom_col() +
    geom_errorbar(aes(ymin = mean - ((1.96*sd)/sqrt(336)), ymax = mean +((1.96*sd)/sqrt(336)))) +
    facet_wrap(~Q8_code) +
    scale_fill_discrete("") +
    scale_x_continuous("", breaks = 1:12, labels = 1:12) +
    theme_bw()

ggsave("subject-plot.png", width = 9, height = 6)
```

# Joining data - this is to join the qualitative data (not run right now)

```{r, eval = FALSE}
library(googlesheets)
g <- gs_title("Teacher Education Technology Competencies Survey_November 12, 2018_20.32")
```

```{r}
d2 <- gs_read(g, ws = 2, skip = 1)
d2 <- d2 %>% rename(Q13 = `Please explain the one or two technology competencies that you consider as being most important to your individual work as a teacher educator.`) %>% slice(-c(338:339))
d2 <- d2 %>% set_names(c("Q13", str_c("Q13-", names(d2)[-1])))
d2 <- d2 %>% filter(!duplicated(Q13))

d3 <- gs_read(g, ws = 3, skip = 1)
d3 <- d3 %>% rename(Q14 = `Please explain one or more of the technology competencies that you consider of low or no importance to your individual work as a teacher educator.`) %>% slice(-c(338:339))
d3 <- d3 %>% set_names(c("Q14", str_c("Q14-", names(d3)[-1])))
d3 <- d3 %>% filter(!duplicated(Q14))

d4 <- gs_read(g, ws = 4, skip = 1)
d4 <- d4 %>% rename(Q15 = `What is important in your work related to educational technology that is not reflected in the TETCs?`) %>% slice(-c(338:339))
d4 <- d4 %>% set_names(c("Q15", str_c("Q15-", names(d4)[-1])))
d4 <- d4 %>% filter(!duplicated(Q15))
```

```{r}
dx <- d %>% 
    left_join(d2) %>% 
    left_join(d3) %>% 
    left_join(d4)

c13 <- dx %>% 
    select(v1:v12, `Q13-1`:`Q13-12`) %>% 
    mutate_all(replace_na, 0) %>% 
    corrr::correlate() %>% 
    slice() %>% 
    fashion() %>% 
    select(v1:v12) %>% 
    slice(13:24)

c14 <- dx %>% 
    select(v1:v12, `Q14-1`:`Q14-12`) %>% 
    mutate_if(is.character, as.numeric) %>% 
    mutate_all(replace_na, 0) %>% 
    corrr::correlate() %>% 
    slice() %>% 
    fashion() %>% 
    select(v1:v12) %>% 
    slice(13:24)

dd <- data.frame(var = str_c("TETC", 1:12),
                 most_imp_r = as.numeric(diag(as.matrix(c13))),
                 least_imp_r = as.numeric(diag(as.matrix(c14))))

write_csv(dd, "most-least-imp-corr.csv")
```
